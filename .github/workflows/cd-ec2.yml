name: CD - Deploy Order Service to EC2

on:
  push:
    branches:
      - devs
      - stages

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: taher2011/order-service
      IMAGE_TAG: ${{ github.ref_name }}

      # üëá DB secrets (GitHub Secrets se aayenge)
      DB_URL: ${{ secrets.DB_URL }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: Deploy based on environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}

          script: |
            echo "üöÄ Deploying environment: $IMAGE_TAG"

            if [ "$IMAGE_TAG" = "dev" ]; then
              APP_PORT=8081
              CONTAINER_NAME=order-service-dev
            elif [ "$IMAGE_TAG" = "stage" ]; then
              APP_PORT=8082
              CONTAINER_NAME=order-service-stage
            else
              echo "‚ùå Unknown environment"
              exit 1
            fi

            echo "üîπ Pulling image"
            docker pull $IMAGE_NAME:$IMAGE_TAG

            echo "üîπ Stopping old container (if exists)"
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            echo "üîπ Running new container on port $APP_PORT"
            docker run -d \
              --name $CONTAINER_NAME \
              -p $APP_PORT:8080 \
              -e SPRING_PROFILES_ACTIVE=$IMAGE_TAG \
              -e SPRING_DATASOURCE_URL=$DB_URL \
              -e SPRING_DATASOURCE_USERNAME=$DB_USERNAME \
              -e SPRING_DATASOURCE_PASSWORD=$DB_PASSWORD \
              $IMAGE_NAME:$IMAGE_TAG

            echo "‚úÖ Deployment completed for $IMAGE_TAG"
